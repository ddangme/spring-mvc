## API ì˜ˆì™¸ ì²˜ë¦¬
HTML í˜ì´ì§€ì˜ ê²½ìš° ì§€ê¸ˆê¹Œì§€ ì„¤ëª…í–ˆë˜ ê²ƒ ì²˜ëŸ¼ 4xx, 5xxì™€ ê°™ì€ ì˜¤ë¥˜ í˜ì´ì§€ë§Œ ìˆìœ¼ë©´ ëŒ€ë¶€ë¶„ ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
ê·¸ëŸ°ë° APIì˜ ê²½ìš° ìƒê°í•  ë‚´ìš©ì´ ë” ë§ë‹¤.
ì˜¤ë¥˜ í˜ì´ì§€ëŠ” ë‹¨ìˆœíˆ ê³ ê°ì—ê²Œ ì˜¤ë¥˜ í™”ë©´ì„ ë³´ì—¬ì£¼ê³  ëì´ì§€ë§Œ, APIëŠ” ê° ì˜¤ë¥˜ ìƒí™©ì— ë§ëŠ” ì˜¤ë¥˜ ì‘ë‹µ ìŠ¤í™ì„ ì •í•˜ê³ , JSONìœ¼ë¡œ ë°ì´í„°ë¥¼ ë‚´ë ¤ì£¼ì–´ì•¼ í•œë‹¤.

## ì„œë¸”ë¦¿ì˜ API ì˜¤ë¥˜ ì²˜ë¦¬
#### [WebServerCustomizer.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2FWebServerCustomizer.java)
- `@Component` ì£¼ì„ ì œê±°
  - ì´ì œ WASì— ì˜ˆì™¸ê°€ ì „ë‹¬ë˜ê±°ë‚˜, `response.sendError()`ê°€ í˜¸ì¶œë˜ë©´ ìœ„ì— ë“±ë¡í•œ ì˜ˆì™¸ í˜ì´ì§€ ê²½ë¡œê°€ í˜¸ì¶œëœë‹¤.


#### [ApiExceptionController.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2Fweb%2Fcontroller%2FApiExceptionController.java)
```java
@Slf4j
@RestController
public class ApiExceptionController {

    @GetMapping("/api/members/{id}")
    public MemberDTO getMember(@PathVariable("id") String id) {
        if (id.equals("ex")) {
            throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
        }

        return new MemberDTO(id, "hello " + id);
    }
    
    @Data
    @AllArgsConstructor
    static class MemberDTO {
        private String memberId;
        private String name;
    }
}
```

ë‹¨ìˆœ íšŒì› ì¡°íšŒ ê¸°ëŠ¥ìœ¼ë¡œ, ì˜ˆì™¸ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ URLì— ì „ë‹¬ëœ `id`ê°’ì´ `ex`ì´ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë„ë¡ ì½”ë“œë¥¼ ì‹¬ì–´ì£¼ì—ˆë‹¤.

##### Postman í…ŒìŠ¤íŠ¸
HTTP Headerì˜ `Accept`ë¥¼ `application/json`ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

###### ì •ìƒ í˜¸ì¶œ
`http://localhost:8080/api/members/spring`  

[ì‹¤í–‰ ê²°ê³¼]
```json
{
    "memberId": "spring",
    "name": "hello spring"
}
```

###### ì˜ˆì™¸ ë°œìƒ í˜¸ì¶œ
```html
<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
</head>

<body>

    <div class="container" style="max-width: 600px">
        <div class="py-5 text-center">
            <h2>500 ì˜¤ë¥˜ í™”ë©´</h2>
        </div>

        <div>
            <p>ì˜¤ë¥˜ í™”ë©´ ì…ë‹ˆë‹¤.</p>
        </div>

        <hr class="my-4">

    </div> <!-- /container -->

</body>

</html>
```

APIë¥¼ ìš”ì²­í–ˆëŠ”ë°, ì •ìƒì˜ ê²½ìš° API ì‘ë‹µì´ JSON í˜•ì‹ ë°ì´í„°ê°€ ë°˜í™˜ëœë‹¤.
ê·¸ëŸ°ë° ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì˜¤ë¥˜ í˜ì´ì§€ HTMLì´ ë°˜í™˜ëœë‹¤. 
í´ë¼ì´ì–¸íŠ¸ëŠ” ì •ìƒ ìš”ì²­ì´ë“ , ì˜¤ë¥˜ ìš”ì²­ì´ë“  JSONì´ ë°˜í™˜ë˜ê¸°ë¥¼ ê¸°ëŒ€í•œë‹¤.
ì›¹ ë¸Œë¼ìš°ì €ê°€ ì•„ë‹Œ ì´ìƒ HTMLì„ ì§ì ‘ ë°›ì•„ì„œ í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ì—†ë‹¤.

ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ì˜¤ë¥˜ í˜ì´ì§€ ì»¨íŠ¸ë¡¤ëŸ¬ë„ JSON ì‘ë‹µì„ í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •í•´ì•¼ í•œë‹¤.


### [ErrorPageController.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2Fweb%2Fcontroller%2FErrorPageController.java) errorPage500Api() ì¶”ê°€
```java
@RequestMapping(value = "/error-page/500", produces = MediaType.APPLICATION_JSON_VALUE)
public ResponseEntity<Map<String, Object>> errorPage500Api(HttpServletRequest request, HttpServletResponse response) {
    log.info("API errorPage 500");
    
    Map<String, Object> result = new HashMap<>();
    Exception ex = (Exception) request.getAttribute(ERROR_EXCEPTION);
    result.put("status", request.getAttribute(ERROR_STATUS_CODE));
    result.put("message", ex.getMessage());

    Integer statusCode = (Integer) request.getAttribute(RequestDispatcher.ERROR_STATUS_CODE);

    return new ResponseEntity<>(result, HttpStatus.valueOf(statusCode));
}
```

`produces = Mediatype.APPLICATION_JSON_VALUE`ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•˜ëŠ” HTTP headerì˜ `Accept`ì˜ ê°’ì´
`application/json`ì¼ ë•Œ í•´ë‹¹ ë©”ì„œë“œê°€ í˜¸ì¶œëœë‹¤ëŠ” ëœ»ì´ë‹¤.
ê²°êµ­ í´ë¼ì´ì–¸íŠ¸ê°€ ë°›ê³  ì‹¶ì€ ë¯¸ë””ì–´íƒ€ì…ì´ `json`ì´ë©´ ì´ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë©”ì†Œë“œê°€ í˜¸ì¶œëœë‹¤.

ì‘ë‹µ ë°ì´í„°ë¥¼ ìœ„í•´ `Map`ì„ ë§Œë“¤ê³  `status`, `message` í‚¤ì— ê°’ì„ í• ë‹¹í–ˆë‹¤.
Jackson ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” `Map`ì„ JSON êµ¬ì¡°ë¡œ ë³€í™˜í•  ìˆ˜ ìˆë‹¤.

`ResponseEntity`ë¥¼ ì‚¬ìš©í•´ì„œ ì‘ë‹µí•˜ê¸° ë•Œë¬¸ì— ë©”ì‹œì§€ ì»¨ë²„í„°ê°€ ë™ì‘í•˜ë©´ì„œ í´ë¼ì´ì–¸íŠ¸ì— JSONì´ ë°˜í™˜ëœë‹¤.

#### Postman í…ŒìŠ¤íŠ¸
`http://localhost:8080/api/members/ex`  

[ì‹¤í–‰ ê²°ê³¼]
```json
{
    "message": "ì˜ëª»ëœ ì‚¬ìš©ì",
    "status": 500
}
```

HTML Headerì— `Accept`ê°€ `application/json`ì´ ì•„ë‹ˆë©´, ê¸°ì¡´ ì˜¤ë¥˜ ì‘ë‹µì¸ HTML ì‘ë‹µì´ í˜¸ì¶œë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## ìŠ¤í”„ë§ ë¶€íŠ¸ ê¸°ë³¸ ì˜¤ë¥˜ ì²˜ë¦¬
API ì˜ˆì™¸ ì²˜ë¦¬ë„ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ ì˜¤ë¥˜ ë°©ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
#### BasicErrorController ì½”ë“œ
```java
@RequestMapping(produces = MediaType.TEXT_HTML_VALUE)
public ModelAndView errorHtml(HttpServletRequest request, HttpServletResponse response) { }

@RequestMapping
public ResponseEntity<Map<String, Object>> error(HttpServletRequest request) { }
```

- `errorHtml()`-`produces = MediaType.TEXT_HTML_VALUE`: í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì˜ Accept í—¤ë” ê°’ì´ `text/html`ì¸ ê²½ìš°ì—ëŠ”
`errorHtml()`ì„ í˜¸ì¶œí•´ì„œ view ë¥¼ ì œê³µí•œë‹¤.
- `error()`: ê·¸ ì™¸ ê²½ìš°ì— í˜¸ì¶œë˜ê³  `ResponseEntity`ë¡œ HTTP Body ì— JSON ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤.

### ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ì˜ˆì™¸ ì²˜ë¦¬
ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ê¸°ë³¸ ì„¤ì •ì€ ì˜¤ë¥˜ ë°œìƒ ì‹œ `/error`ë¥¼ ì˜¤ë¥˜ í˜ì´ì§€ë¡œ ìš”ì²­í•œë‹¤.

`BasicErrorController`ëŠ” ì´ ê²½ë¡œë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë°›ëŠ”ë‹¤. (`server.error.path`ë¡œ ìˆ˜ì • ê°€ëŠ¥, ê¸°ë³¸ ê²½ë¡œ `/error`)

#### Postman ìœ¼ë¡œ ì‹¤í–‰
1. [WebServerCustomizer.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2FWebServerCustomizer.java)ì˜ `@Component` ì£¼ì„ ì²˜ë¦¬í•˜ê¸°.
2. [application.properties](..%2F..%2Fsrc%2Fmain%2Fresources%2Fapplication.properties) ì„¤ì • ë³€ê²½
    ```properties
    server.error.include-binding-errors=always
    server.error.include-exception=true
    server.error.include-message=always
    server.error.include-stacktrace=always
    ```
3. `GET: http://localhost:8080/api/members/ex` ì‹¤í–‰
    ```
    {
        "timestamp": "2021-04-28T00:00:00.000+00:00", "status": 500,
        "error": "Internal Server Error",
        "exception": "java.lang.RuntimeException",
        "trace": "java.lang.RuntimeException: ì˜ëª»ëœ ì‚¬ìš©ì\n\tat
        hello.exception.web.api.ApiExceptionController.getMember(ApiExceptionController
        .java:19...,
        "message":"ì˜ëª»ëœ ì‚¬ìš©ì",
        "path": "/api/members/ex"
    }
    ```

### Html í˜ì´ì§€ vs API ì˜¤ë¥˜
`BasicErrorController`ë¥¼ í™•ì¥í•˜ë©´ JSON ë©”ì‹œì§€ë„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° API ì˜¤ë¥˜ëŠ” ì¡°ê¸ˆ ë’¤ì— ì„¤ëª…í• 
`@ExceptionHandler`ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ë‚˜ì€ ë°©ë²•ì´ë¯€ë¡œ ì§€ê¸ˆì€ `BasicErrorController`ë¥¼ í™•ì¥í•´ì„œ
JSON ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤ ì •ë„ë¡œë§Œ ì´í•´í•˜ì.

ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì œê³µí•˜ëŠ” `BasicErrorController`ëŠ” HTML í˜ì´ì§€ë¥¼ ì œê³µí•˜ëŠ” ê²½ìš°ì—ëŠ” ë§¤ìš° í¸ë¦¬í•˜ë‹¤.
4xx, 5xx ë“±ë“± ëª¨ë‘ ì˜ ì²˜ë¦¬í•´ì¤€ë‹¤. ê·¸ëŸ°ë° API ì˜¤ë¥˜ ì²˜ë¦¬ëŠ” ë‹¤ë¥¸ ì°¨ì›ì˜ ì´ì•¼ê¸°ì´ë‹¤.
APIë§ˆë‹¤, ê°ê°ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ë‚˜ ì˜ˆì™¸ë§ˆë‹¤ ì„œë¡œ ë‹¤ë¥¸ ì‘ë‹µ ê²°ê³¼ë¥¼ ì¶œë ¥í•´ì•¼ í•  ìˆ˜ë„ ìˆë‹¤.
ì˜ˆë¥¼ ë“¤ì–´ì„œ íšŒì›ê³¼ ê´€ë ¨ëœ APIì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•  ë•Œ ì‘ë‹µê³¼, ìƒí’ˆê³¼ ê´€ë ¨ëœ APIì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ì— ë”°ë¼ ê·¸ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ ë§¤ìš° ì„¸ë°€í•˜ê³  ë³µì¡í•˜ë‹¤. ë”°ë¼ì„œ ì´ ë°©ë²•ì€ HTML í™”ë©´ì„ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©í•˜ê³ , API ì˜¤ë¥˜ ì²˜ë¦¬ëŠ” ë’¤ì— ì„¤ëª…í•  `@ExceptionHandler`ë¥¼ ì‚¬ìš©í•˜ì.

## HandlerExceptionResolver
ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ì„œë¸”ë¦¿ì„ ë„˜ì–´ WASê¹Œì§€ ì˜ˆì™¸ê°€ ì „ë‹¬ë˜ë©´ HTTP ìƒíƒœ ì½”ë“œê°€ 500ìœ¼ë¡œ ì²˜ë¦¬ëœë‹¤.
ë°œìƒí•˜ëŠ” ì˜ˆì™¸ì— ë”°ë¼ì„œ 400, 404 ë“±ë“± ë‹¤ë¥¸ ìƒíƒœ ì½”ë“œë¡œ ì²˜ë¦¬í•˜ê³ , ì˜¤ë¥˜ ë©”ì‹œì§€ì™€ í˜•ì‹ ë“±ì„ API ë§ˆë‹¤ ë‹¤ë¥´ê²Œ ì²˜ë¦¬í•˜ì.

### ìƒíƒœì½”ë“œ ë³€í™˜
ì˜ˆë¥¼ ë“¤ì–´ì„œ `IllegalArgumentException`ì„ ì²˜ë¦¬í•˜ì§€ ëª»í•´ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ ë°–ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ì¼ì´ ë°œìƒí•˜ë©´ HTTP ìƒíƒœ ì½”ë“œë¥¼ 400ìœ¼ë¡œ ì²˜ë¦¬í•˜ì.

#### [ApiExceptionController.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2Fweb%2Fcontroller%2FApiExceptionController.java) getMember() ìˆ˜ì • 
```java
@GetMapping("/api/members/{id}")
public MemberDTO getMember(@PathVariable("id") String id) {
    if (id.equals("ex")) {
        throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
    }

    if (id.equals("bad")) {
        throw new IllegalArgumentException("ì˜ëª»ëœ ê°’ ì…ë ¥");
    }

    return new MemberDTO(id, "hello " + id);
}
```
`http://localhost:8080/api/members/bad`ë¥¼ ì‹¤í–‰í•´ë³´ë©´ ìƒíƒœ ì½”ë“œê°€ 500ì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
##### ì‹¤í–‰ ê²°ê³¼
```json
{
      "status": 500,
      "error": "Internal Server Error",
      "exception": "java.lang.IllegalArgumentException",
      "path": "/api/members/bad"
}
```

### HandlerExceptionResolver
ìŠ¤í”„ë§ MVC ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬(í•¸ë“¤ëŸ¬) ë°–ìœ¼ë¡œ ì˜ˆì™¸ê°€ ë˜ì ¸ì§„ ê²½ìš° ì˜ˆì™¸ë¥¼ í•´ê²°í•˜ê³ , ë™ì‘ì„ ìƒˆë¡œ ì •ì˜í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•œë‹¤.
ì»¨íŠ¸ë¡¤ëŸ¬ ë°–ìœ¼ë¡œ ë˜ì ¸ì§„ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê³ , ë™ì‘ ë°©ì‹ì„ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ë©´ `HandlerExceptionResolver`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
ì¤„ì—¬ì„œ `ExceptionResolver`ë¼ê³  í•œë‹¤.

#### ExceptionResolver ì ìš© ì „
![ExceptionResolver ì ìš© ì „.png](imgs%2FExceptionResolver%20%EC%A0%81%EC%9A%A9%20%EC%A0%84.png)

#### ExceptionResolver ì ìš© í›„
![ExceptionResolver ì ìš© í›„.png](imgs%2FExceptionResolver%20%EC%A0%81%EC%9A%A9%20%ED%9B%84.png)

> ğŸ€ `ExceptionResolver`ë¡œ ì˜ˆì™¸ë¥¼ í•´ê²°í•´ë„ `postHandle()`ì€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.

### HandlerExceptionResolver ì¸í„°í˜ì´ìŠ¤
```java
public interface HandlerExceptionResolver {
    ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex);
}
```
- `handler`: í•¸ë“¤ëŸ¬(ì»¨íŠ¸ë¡¤ëŸ¬) ì •ë³´
- `Exception ex`: í•¸ë“¤ëŸ¬(ì»¨íŠ¸ë¡¤ëŸ¬)ì—ì„œ ë°œìƒí•œ ì˜ˆì˜¤

#### [MyHandlerExceptionResolver.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2FMyHandlerExceptionResolver.java) ìƒì„±
```java
@Override
public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
    try {
        if (ex instanceof IllegalArgumentException) {
            log.info("IllegalArgumentException resolver to 400");
            response.sendError(HttpServletResponse.SC_BAD_REQUEST, ex.getMessage());

            return new ModelAndView();
        }
    } catch (IOException e) {
        log.error("resolver ex", e);
    }
    
    return null;
}
```
- `ExceptionResolver`ê°€ `ModelAndView`ë¥¼ ë°˜í™˜í•˜ëŠ” ì´ìœ ëŠ” ë§ˆì¹˜ try, catchë¥¼ í•˜ë“¯ì´, `exception`ì„ ì²˜ë¦¬í•´ì„œ
ì •ìƒ íë¦„ ì²˜ëŸ¼ ë³€ê²½í•˜ëŠ” ê²ƒì´ ëª©ì ì´ë‹¤. ì´ë¦„ ê·¸ëŒ€ë¡œ `Exception`ì„ Resolverí•˜ëŠ” ê²ƒì´ ëª©ì ì´ë‹¤.

ì—¬ê¸°ì„œëŠ” `IllegalArgumentException`ì´ ë°œìƒí•˜ë©´ `response.sendError(400)`ë¥¼ í˜¸ì¶œí•´ì„œ
HTTP ìƒíƒœ ì½”ë“œë¥¼ 400ìœ¼ë¡œ ì§€ì •í•˜ê³ , ë¹ˆ `ModelAndView`ë¥¼ ë°˜í™˜í•œë‹¤.

### ë°˜í™˜ ê°’ì— ë”°ë¥¸ ë™ì‘ ë°©ì‹
`HandlerExceptionResolver`ì˜ ë°˜í™˜ ê°’ì— ë”°ë¥¸ `DispatcherServlet`ì˜ ë™ì‘ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
- ë¹ˆ ModelAndView: `new ModelAndView()`ì²˜ëŸ¼ ë¹ˆ `ModelAndView`ë¥¼ ë°˜í™˜í•˜ë©´ ë·°ë¥¼ ë Œë”ë§í•˜ì§€ ì•Šê³  ì •ìƒíë¦„ìœ¼ë¡œ ì„œë¸”ë¦¿ì´ ë¦¬í„´ëœë‹¤.
- ModelAndView ì§€ì •: `ModelAndView`ì— `View`, `Model` ë“±ì˜ ì •ë³´ë¥¼ ì§€ì •í•´ì„œ ë°˜í™˜í•˜ë©´ ë·°ë¥¼ ë Œë”ë§í•œë‹¤.
- null: `null`ì„ ë°˜í™˜í•˜ë©´, ë‹¤ìŒ `ExceptionResolver`ë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰í•œë‹¤. ë§Œì•½ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” `ExceptionResolver`ê°€ ì—†ìœ¼ë©´
ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì•ˆë˜ê³ , ê¸°ì¡´ì— ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì„œë¸”ë¦¿ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.


### ExceptionResolver í™œìš©
- ì˜ˆì™¸ ìƒíƒœ ì½”ë“œ ë³€í™˜
  - ì˜ˆì™¸ë¥¼ `response.sendError(xxx)` í˜¸ì¶œë¡œ ë³€ê²½í•´ì„œ ì„œë¸”ë¦¿ì—ì„œ ìƒíƒœ ì½”ë“œì— ë”°ë¥¸ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ìœ„ì„í•œë‹¤.
  - ì´í›„ WASëŠ” ì„œë¸”ë¦¿ ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ì°¾ì•„ì„œ ë‚´ë¶€ í˜¸ì¶œ, ì˜ˆë¥¼ ë“¤ì–´ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•œ `/error`ê°€ í˜¸ì¶œëœë‹¤.
- ë·° í…œí”Œë¦¿ ì²˜ë¦¬
  - `ModelAndView`ì— ê°’ì„ ì±„ì›Œì„œ ì˜ˆì™¸ì— ë”°ë¥¸ ìƒˆë¡œìš´ ì˜¤ë¥˜ í™”ë©´ ë·° ë Œë”ë§í•´ì„œ ê³ ê°ì—ê²Œ ì œê³µ
- API ì‘ë‹µ ì²˜ë¦¬
  - `response.getWriter().println("hello");`ì²˜ëŸ¼ HTTP ì‘ë‹µ ë°”ë””ì— ì§ì ‘ ë°ì´í„°ë¥¼ ë„£ì–´ì£¼ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤.
  - ì—¬ê¸°ì— JSONìœ¼ë¡œ ì‘ë‹µí•˜ë©´ API ì‘ë‹µ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤.

### [WebConfig.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2FWebConfig.java) ìˆ˜ì • - extendHandlerExceptionResolvers ì¶”ê°€
```java
@Override
public void extendHandlerExceptionResolvers(List<HandlerExceptionResolver> resolvers) {
    resolvers.add(new MyHandlerExceptionResolver());
}
```
`configureHandlerExceptionResolver(...)`ë¥¼ ì‚¬ìš©í•˜ë©´ ìŠ¤í”„ë§ì´ ê¸°ë³¸ìœ¼ë¡œ ë“±ë¡í•˜ëŠ”
`ExceptionResolver`ê°€ ì œê±°ë˜ë¯€ë¡œ ì£¼ì˜, `extendHandlerExceptionResolvers`ë¥¼ ì‚¬ìš©í•˜ì.

#### Postman í…ŒìŠ¤íŠ¸
- `http://localhost:8080/api/members/ex`
    ```json
  {
      "timestamp": "2024-04-13T17:06:17.070+00:00",
      "status": 500,
      "error": "Internal Server Error",
      "exception": "java.lang.RuntimeException",
      "message": "",
      "path": "/api/members/ex"
  }
    ```
- `http://localhost:8080/api/members/bad`
    ```json
  {
      "timestamp": "2024-04-13T17:07:27.266+00:00",
      "status": 400,
      "error": "Bad Request",
      "exception": "java.lang.IllegalArgumentException",
      "message": "",
      "path": "/api/members/bad"
  }
    ```

## HandlerExceptionResolver í™œìš©
### ì˜ˆì™¸ë¥¼ ì—¬ê¸°ì„œ ë§ˆë¬´ë¦¬í•˜ê¸°
ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ WASê¹Œì§€ ì˜ˆì™¸ê°€ ë˜ì ¸ì§€ê³ , WASì—ì„œ ì˜¤ë¥˜ í˜ì´ì§€ ì •ë³´ë¥¼ ì°¾ì•„ ë‹¤ì‹œ `/error`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê³¼ì •ì€ ë„ˆë¬´ ë³µì¡í•˜ë‹¤.
`ExceptionResolver`ë¥¼ í™œìš©í•˜ë©´ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì´ëŸ° ë³µì¡í•œ ê³¼ì • ì—†ì´ ì—¬ê¸°ì—ì„œ ë¬¸ì œë¥¼ ê¹œëŒí•˜ê²Œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

### [UserException.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2Fweb%2Fexception%2FUserException.java) ìƒì„±
```java
public class UserException extends RuntimeException {
    
    public UserException() {
        super();
    }

    public UserException(String message) {
        super(message);
    }

    public UserException(String message, Throwable cause) {
        super(message, cause);
    }

    public UserException(String message, Throwable cause, boolean enableSuppression, boolean writeableStackTrace) {
        super(message, cause, enableSuppression, writeableStackTrace);
    }
    
}
```

### [ApiExceptionController.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2Fweb%2Fcontroller%2FApiExceptionController.java) - getMember() ìˆ˜ì •
```java
@GetMapping("/api/members/{id}")
public MemberDTO getMember(@PathVariable("id") String id) {
    if (id.equals("ex")) {
        throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
    }

    if (id.equals("bad")) {
        throw new IllegalArgumentException("ì˜ëª»ëœ ê°’ ì…ë ¥");
    }

    if (id.equals("user-ex")) {
        throw new UserException("ì‚¬ìš©ì ì˜¤ë¥˜");
    }

    return new MemberDTO(id, "hello " + id);
}
``` 

### [UserHandlerExceptionResolver.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2FUserHandlerExceptionResolver.java) ìƒì„±
```java
package hello.itemservice;

import com.fasterxml.jackson.databind.ObjectMapper;
import hello.itemservice.web.exception.UserException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.servlet.HandlerExceptionResolver;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

@Slf4j
public class UserHandlerExceptionResolver implements HandlerExceptionResolver {

    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {

        try {
            if (ex instanceof UserException) {
                log.info("UserException resolver to 400");
                String acceptHeader = request.getHeader("accept");
                response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
                if ("application/json".equals(acceptHeader)) {
                    Map<String, Object> errorResult = new HashMap<>();
                    errorResult.put("ex", ex.getClass());
                    errorResult.put("message", ex.getMessage());
                    String result =
                            objectMapper.writeValueAsString(errorResult);
                    response.setContentType("application/json");
                    response.setCharacterEncoding("utf-8");
                    response.getWriter().write(result);
                    return new ModelAndView();
                } else {
                    //TEXT/HTML
                    return new ModelAndView("error/500");
                }
            }
        } catch (IOException e) {
            log.error("resolver ex", e);
        }
        return null;
    }
}
```

HTTP ìš”ì²­ í—¤ë”ì˜ `ACCEPT` ê°’ì´ `application/json`ì´ë©´ JSONìœ¼ë¡œ ì˜¤ë¥˜ë¥¼ ë‚´ë ¤ì£¼ê³ , ê·¸ ì™¸ ê²½ìš°ì—ëŠ” error/500ì— ìˆëŠ”
HTML ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ë³´ì—¬ì¤€ë‹¤.

### [WebConfig.java](..%2F..%2Fsrc%2Fmain%2Fjava%2Fhello%2Fitemservice%2FWebConfig.java) - extendHandlerExceptionResolvers() ìˆ˜ì •
```java
@Override
public void extendHandlerExceptionResolvers(List<HandlerExceptionResolver> resolvers) {
    resolvers.add(new MyHandlerExceptionResolver());
    resolvers.add(new UserHandlerExceptionResolver());
}
```

### PostMan ì‹¤í–‰
`http://localhost:8080/api/members/user-ex`

#### ì‹¤í–‰ ê²°ê³¼
1. ACCEPT: `application/json`
    ```json
    {
        "ex": "hello.itemservice.web.exception.UserException",
        "message": "ì‚¬ìš©ì ì˜¤ë¥˜"
    }
    ```
2. ACCEPT: `text/html`
    ```html
    <!DOCTYPE HTML>
    <html>
    ...
    </html>
    ```
   
### ì •ë¦¬
`ExceptionResolver`ë¥¼ ì‚¬ìš©í•˜ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ `ExceptionResolver`ì—ì„œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•œë‹¤.

ë”°ë¼ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê¹Œì§€ ì˜ˆì™¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šê³ , ìŠ¤í”„ë§ MVCì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ëŠ” ëì´ ë‚œë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ WAS ì…ì¥ì—ì„œëŠ” ì •ìƒ ì²˜ë¦¬ê°€ ëœ ê²ƒì´ë‹¤. ì´ë ‡ê²Œ ì˜ˆì™¸ë¥¼ ì´ê³³ì—ì„œ ëª¨ë‘ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ í•µì‹¬ì´ë‹¤.

ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê¹Œì§€ ì˜ˆì™¸ê°€ ì˜¬ë¼ê°€ë©´ ë³µì¡í•˜ê³  ì§€ì €ë¶„í•˜ê²Œ ì¶”ê°€ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ëœë‹¤.
ë°˜ë©´ì— `ExceptionResolver`ë¥¼ ì‚¬ìš©í•˜ë©´ ì˜ˆì™¸ ì²˜ë¦¬ê°€ ê¹”ë”í•´ì§„ë‹¤.
